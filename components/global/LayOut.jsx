import Head from 'next/head';
import NavBar from './NavBar';
import React, { useEffect , useState } from 'react';
import { getAuth } from "firebase/auth";
import { useAuthState } from 'react-firebase-hooks/auth';
import { logOutExternal } from '../Auth/logOutExternal';
import LogInModal from '../Auth/LogInModal';
import { useAppSelector , useAppDispatch } from '../../redux/hooks';
import { setLogInFlag } from '../../redux/features/actions/auth';

const Layout = ({ children }) => {
  const dispatch = useAppDispatch()
  const { logInFlag } = useAppSelector(state => state.auth)
  const auth = getAuth(); // instance of auth method
  const [user, loading] = useAuthState(auth); // user data
  const [ logged , setLogged ] = useState(null);
  const [ ready , setReady ] = useState(false);
  const logOut = () => { // runs the external log out function
    logOutExternal(auth)
  };

  useEffect(() => {
    if(logged !== null) {
      setTimeout(() =>{
        setReady(true)
      },90000)
    }
  },[logged]);

  useEffect(() => {
    if (ready === true) {
      if (logged === false) {
        dispatch(setLogInFlag(true))
      }
    }
  },[ready]);  // eslint-disable-line

  useEffect(() => {
    if (logged === null) {
      setLogged(false)
    } else if (logged === false) {
      setLogged(true) 
    } else {
      setLogged(false)
    }
  },[user]) // eslint-disable-line

  return (
    <div className='w-screen h-screen flex flex-col bg-dokuso-white'>
      <Head>
        <title>Dokus≈ç</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href=""/>
      </Head>
      <NavBar logOut={logOut} user={user}/>
      <main className='flex flex-col flex-auto p-0 m-0 overflow-auto scrollbar'>
        {children}
        {logInFlag && <LogInModal/>}
      </main>
    </div>
  )
}

export default Layout;